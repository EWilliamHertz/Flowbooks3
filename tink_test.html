<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tink Connection Test</title>
    <!-- 1. Ladda Tinks anslutningsbibliotek -->
    <script src="https://link.tink.com/1.0.0/tink-link.js" defer></script>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; flex-direction: column; }
        button { font-size: 2rem; padding: 1rem 2rem; cursor: pointer; }
        #log { margin-top: 20px; padding: 10px; border: 1px solid #ccc; width: 80%; height: 200px; overflow-y: scroll; font-family: monospace; }
    </style>
</head>
<body>

    <h1>Tink Integration Test</h1>
    <button id="connect-button">Starta Bankanslutning</button>
    <div id="log">Väntar på åtgärd...<br></div>

    <!-- 2. Ladda Firebase SDK -->
    <script type="module">
        // Importera nödvändiga Firebase-delar
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-functions.js";

        // Din Firebase-konfiguration
        const firebaseConfig = {
            apiKey: "AIzaSyDGamRgGYt-Bl2Mj0znqAG7uFWM9TC0VgU",
            authDomain: "flowbooks-73cd9.firebaseapp.com",
            projectId: "flowbooks-73cd9",
            storageBucket: "flowbooks-73cd9.appspot.com",
            messagingSenderId: "226642349583",
            appId: "1:226642349583:web:e2376d9283d2d3c33ddd7a"
        };

        // Initialisera Firebase
        const app = initializeApp(firebaseConfig);
        const functions = getFunctions(app);
        
        // Referenser till dina backend-funktioner
        const exchangeCodeFunction = httpsCallable(functions, 'exchangeCodeForToken');
        const fetchBankDataFunction = httpsCallable(functions, 'fetchBankData');

        const logElement = document.getElementById('log');
        const button = document.getElementById('connect-button');

        function log(message) {
            logElement.innerHTML += message + '<br>';
            logElement.scrollTop = logElement.scrollHeight;
        }

        button.addEventListener('click', async () => {
            log('Knappen klickad. Startar processen...');
            button.disabled = true;
            button.textContent = 'Arbetar...';

            try {
                // STEG 1: Öppna Tink Link och få en kod
                log('Försöker öppna Tink Link...');
                const code = await new Promise((resolve, reject) => {
                    try {
                        const tinkLink = TinkLink.create({
                            clientId: "3062b812f1d340b986a70df838755c29",
                            redirectUri: window.location.href, // Använder denna sidas URL
                            market: 'SE',
                            locale: 'sv_SE',
                            onSuccess: (data) => resolve(data.code),
                            onError: (error) => reject(error)
                        });
                        tinkLink.open();
                    } catch (e) {
                        reject(e);
                    }
                });
                log('Tink Link lyckades! Fick auktoriseringskod.');

                // STEG 2: Skicka koden till backend för att få en token
                log('Skickar kod till Firebase-funktion...');
                const tokenResult = await exchangeCodeFunction({ code: code });
                const accessToken = tokenResult.data.accessToken;
                if (!accessToken) throw new Error("Fick ingen access token från backend.");
                log('Fick access token från backend!');

                // STEG 3: Använd token för att hämta bankdata
                log('Hämtar bankdata med access token...');
                const bankDataResult = await fetchBankDataFunction({ accessToken: accessToken });
                log('Hämtade bankdata!');
                log('SUCCESS! Antal konton: ' + bankDataResult.data.accounts.length);
                log('Antal transaktioner: ' + bankDataResult.data.transactions.length);
                
                alert("GRATTIS! Hela flödet fungerade!");

            } catch (error) {
                log('ETT FEL INTRÄFFADE: ' + error.message);
                console.error(error);
                alert("Ett fel inträffade. Kontrollera loggen på testsidan för detaljer.");
            } finally {
                button.disabled = false;
                button.textContent = 'Starta Bankanslutning';
            }
        });
    </script>

</body>
</html>
